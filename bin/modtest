#!/usr/bin/env luajit

modtest = {
	log = function(level, messagefmt, ...)
		local delta = 0
		if type(level) == "table" then
			level, delta = unpack(level)
		end
		-- TODO filter levels
		local info = debug.getinfo(2 + delta, "Sl")

		local msg = ("%s:%i: %s\n"):format(info.short_src, info.currentline, messagefmt:format(...))

		io.write(msg)
		io.flush()
	end
}

local this_script = arg[0]
local our_path = this_script:match("^(.*)/[^/]+$") or "."

function modtest.dofile(...)
	local to_do = table.concat({our_path, ...}, "/") .. ".lua"
	modtest.log({"debug", 1}, "doing %q", to_do)
	return dofile(to_do)
end

function modtest.loadfile(...)
	local to_load = table.concat({our_path, ...}, "/") .. ".lua"
	modtest.log({"debug", 1}, "loading %q", to_load)
	return loadfile(to_load)
end

modtest.dofile("util")
modtest.dofile("parse_args")
modtest.dofile("load_mods")

modtest.args = modtest.parse_args(arg)

modtest.dofile("faketest", "init")

modtest.load_mods()
